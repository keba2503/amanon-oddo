<?xml version="1.0" encoding="UTF-8" ?>
<odoo>

     <record id="res_config_settings_view_form" model="ir.ui.view">
        <field name="name">res.config.settings.view.form.l10n_pe_edi_base</field>
        <field name="model">res.config.settings</field>
        <field name="priority" eval="40" />
        <field name="inherit_id" ref="base.res_config_settings_view_form" />
        <field name="arch" type="xml">
            <xpath expr="//form" position="inside">
                <app data-string="E-Documents" string="E-Documents" name="l10n_pe_edi_base" groups="account.group_account_manager">
                    <block title="Electronic documents configuration" name="l10n_pe_edi_base_settings" id="l10n_pe_edi_base_settings">
                        <!-- Campo invisible para verificar si Enterprise EDI está instalado -->
                        <field name="l10n_pe_enterprise_edi_installed" invisible="1"/>
                        
                        <!-- Mensaje de advertencia solo visible cuando Enterprise EDI está instalado -->
                        <div invisible="not l10n_pe_enterprise_edi_installed or not l10n_pe_edi_send_invoice" 
                            class="alert alert-warning mb-3" role="alert">
                            <div class="d-flex align-items-center">
                                <i class="fa fa-exclamation-triangle me-2" role="img" aria-label="Warning" title="Warning"></i>
                                <div>
                                    <p class="mb-0">
                                        <strong>Enterprise EDI Detected:</strong> You have the Odoo Enterprise 
                                        <strong>l10n_pe_edi</strong> module installed. You need to deactivate 
                                        the native UBL sending system to avoid conflicts with your selected provider.
                                    </p>
                                    <p class="mb-2">
                                        <strong>How to deactivate:</strong> Go to your accounting journals and remove 
                                        <strong>"Peru UBL 2.1"</strong> from the <strong>Electronic Data Interchange</strong> field 
                                        (<code>edi_format_ids</code>).
                                    </p>
                                    <p class="mb-0">
                                        <strong>Alternative:</strong> If you cannot remove the UBL format from existing journals, 
                                        create new journals specifically for Odoofact management.
                                    </p>
                                </div>
                            </div>
                        </div>
                        <!-- Campo computado para detectar POS EDI -->
                        <field name="l10n_pe_edi_pos_installed" invisible="1"/>

                        <!-- Mensaje de advertencia si POS EDI está instalado -->
                        <div class="alert alert-danger mb-3" role="alert"
                            invisible="not l10n_pe_edi_pos_installed">
                            <div class="d-flex align-items-center">
                                <i class="fa fa-exclamation-circle me-2" role="img" aria-label="Important" title="Important"></i>
                                <div>
                                    <p class="mb-0">
                                        <strong>Conflict detected:</strong> The Enterprise module <strong>l10n_pe_edi_pos</strong> is installed. This may cause incompatibilities with Odoofact POS integration.
                                    </p>
                                    <p class="mb-2">
                                        <strong>Required action:</strong> Uninstall or disable the <code>l10n_pe_edi_pos</code> Enterprise module (Apps) to avoid conflicts with Odoofact. If you must keep both, use a separate POS without the Enterprise EDI integration.
                                    </p>
                                    <p class="mb-0">
                                        Consult your administrator before proceeding.
                                    </p>
                                </div>
                            </div>
                        </div>
                        <setting id="odoofact_einvoicing_pse" help="Select your PSE / OSE provider" company_dependent="1">
                            <field name="l10n_pe_edi_send_invoice"/>
                            <field  invisible="l10n_pe_edi_send_invoice == False"
                                    name="l10n_pe_edi_ose_id"
                                    required="l10n_pe_edi_send_invoice == True"
                                    options="{'no_create': True, 'no_create_edit': True}"
                                    company_dependent="1"
                                />
                            <div class="mt8" invisible="l10n_pe_edi_send_invoice == False">
                                <button
                                    name="%(l10n_pe_edi_base.l10n_pe_edi_shop_action)d"
                                    icon="oi-arrow-right"
                                    type="action"
                                    string="Configure Shops and Tokens"
                                    class="btn-link"                                
                                />                   
                            </div>
                        </setting>
                        <setting id="odoofact_einvoicing_active" string="Activation" help="Active your account and configure Odoo following the insructions" invisible="not l10n_pe_edi_send_invoice">
                            <div class="mt16">
                                <ul>
                                    <li>
                                        <a href="https://www.nubefact.com/registro" class="oe-link" target="_blank"> Request an account</a>
                                    </li>
                                    <li>
                                        <a  href="https://www.operu.pe/knowledge/article/70" class="oe-link" target="_blank">Follow the instructions</a>
                                    </li>
                                </ul>            
                            </div>
                        </setting>
                        <setting id="odoofact_einvoicing_cron" string="Send e-documents automatically" help="Choose the period to send e-documents" invisible="not l10n_pe_edi_send_invoice" company_dependent="1">
                            <div class="text-nowrap fw-bold">
                                Interval Unit for sending 
                                <field name="l10n_pe_edi_send_invoice_interval_unit" required="l10n_pe_edi_send_invoice" class="oe_inline" company_dependent="1"/>
                            </div>
                            <div class="text-nowrap fw-bold">
                                Next Execution 
                                <field name="l10n_pe_edi_send_invoice_next_execution_date" required="l10n_pe_edi_send_invoice" class="oe_inline" company_dependent="1"/>
                            </div>
                        </setting>
                    </block>
                </app>
            </xpath>
        </field>
    </record>

    <record id="l10n_pe_edi_settings_action" model="ir.actions.act_window">
        <field name="name">Settings</field>
        <field name="res_model">res.config.settings</field>
        <field name="view_mode">form</field>
        <field name="target">inline</field>
        <field name="context">{'module' : 'l10n_pe_edi_base', 'bin_size': False}</field>
    </record>
</odoo>
